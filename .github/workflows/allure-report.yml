name: Generate and Publish Allure Report

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for Allure history

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Cypress tests (if Laravel server available)
        continue-on-error: true
        run: |
          echo "Note: Tests require Laravel app running at http://127.0.0.1:8000"
          echo "To run tests in CI, you need to setup Laravel server first"
          echo "For now, generating report from existing allure-results if available"
          # Uncomment below when Laravel server is setup in CI
          # npm run cypress:run:allure || true

      - name: Install Allure Commandline
        run: |
          wget https://github.com/allure-framework/allure2/releases/download/2.34.1/allure-2.34.1.tgz
          tar -zxvf allure-2.34.1.tgz
          sudo mv allure-2.34.1 /opt/allure
          sudo ln -s /opt/allure/bin/allure /usr/local/bin/allure

      - name: Generate Allure Report
        if: always()
        run: |
          # Create allure-results if it doesn't exist (for first run)
          mkdir -p allure-results || true
          # Generate report
          allure generate allure-results --clean -o allure-report || echo "No test results found, creating empty report"
          # Create index.html if report generation failed
          if [ ! -f "allure-report/index.html" ]; then
            mkdir -p allure-report
            echo '<!DOCTYPE html><html><head><title>Allure Report</title></head><body><h1>No test results yet</h1><p>Run tests to generate report</p></body></html>' > allure-report/index.html
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './allure-report'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

