name: Generate and Publish Allure Report

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for Allure history

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Cypress tests (if Laravel server available)
        continue-on-error: true
        run: |
          echo "Note: Tests require Laravel app running at http://127.0.0.1:8000"
          echo "To run tests in CI, you need to setup Laravel server first"
          echo "For now, generating report from existing allure-results if available"
          # Uncomment below when Laravel server is setup in CI
          # npm run cypress:run:allure || true

      - name: Install Allure Commandline
        run: |
          wget https://github.com/allure-framework/allure2/releases/download/2.34.1/allure-2.34.1.tgz
          tar -zxvf allure-2.34.1.tgz
          sudo mv allure-2.34.1 /opt/allure
          sudo ln -s /opt/allure/bin/allure /usr/local/bin/allure

      - name: Check for pre-generated report
        id: check_report
        run: |
          if [ -d "docs/allure-report" ] && [ -f "docs/allure-report/index.html" ]; then
            echo "report_exists=true" >> $GITHUB_OUTPUT
            echo "Found pre-generated report in docs/allure-report"
          else
            echo "report_exists=false" >> $GITHUB_OUTPUT
            echo "No pre-generated report found, will generate from allure-results"
          fi

      - name: Use pre-generated report or generate new one
        if: always()
        run: |
          if [ "${{ steps.check_report.outputs.report_exists }}" == "true" ]; then
            echo "Using pre-generated report from docs/allure-report"
            cp -r docs/allure-report ./allure-report
          else
            echo "Generating report from allure-results..."
            mkdir -p allure-results || true
            # Generate report if allure-results exists
            if [ -d "allure-results" ] && [ "$(ls -A allure-results)" ]; then
              allure generate allure-results --clean -o allure-report || echo "Failed to generate report"
            fi
            # Create placeholder if no report exists
            if [ ! -f "allure-report/index.html" ]; then
              mkdir -p allure-report
              echo '<!DOCTYPE html><html><head><title>Allure Report</title><meta charset="utf-8"></head><body style="font-family: Arial; padding: 40px; text-align: center;"><h1>Allure Report</h1><p>No test results available yet.</p><p>To update this report:</p><ol style="text-align: left; max-width: 600px; margin: 20px auto;"><li>Run tests locally: <code>npm run cypress:run:allure</code></li><li>Generate report: <code>npm run allure:generate</code></li><li>Copy report to docs folder: <code>npm run deploy:report</code></li><li>Commit and push to update GitHub Pages</li></ol></body></html>' > allure-report/index.html
            fi
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './allure-report'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

